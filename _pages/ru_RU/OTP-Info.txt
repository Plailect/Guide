---
title: "Информация по OTP"
permalink: /otp-info.html
lang: ru_RU
ref: otp-info
---

OTP - это 0x100-байтовая область, вероятно, случайных данных, расположенная по адресу 0x10012000. Судя по всему, уникальные ключи консоли генерируются на основе этих данных, однако, как именно это происходит, до сих пор точно не известно. Скорее всего, эта область содержит уникальные для каждой данные и может быть расшифрована только бутромом, но мы не узнаем, как это происходит, пока кто-нибудь не сдампит весь защищённый бутром. На данный момент нет сведений об успешной попытке сдампить защищённый бутром.

До версии 3.0.0-X, область 0x10012000 (OTP) не была защищена и злоумышленник мог сдампить ее, получив права на запуск программного кода на уровне ARM9.

После версии 3.0.0-X, Nintendo стали блокировать эту область с помощью регистра CFG_SYSPROT9, который объявляется на очень раннем этапе загрузки, блокируя загрузчик задолго до того, как мы можем получить возможность выполнять код. Этот регистр может быть задан ровно один раз, и его нельзя будет отключить, пока вы полностью не выключите устройство, исходя из чего невозможно сдампить OTP на прошивках выше 3.0.0-X.

Однако, существует способ сдампить хэш OTP на версии 9.6.0-X. Поскольку Kernel9Loader не очищает регистр SHA_HASH после использования, дампинг этого регистра даст хэш OTP, который был передан Kernel9 из Kernel9Loader. Кроме того, существует старая уязвимость, позволяющая не очищать RAM после перезагрузки MCU через i2c.

Все это позволяет провести аппаратную атаку, в которой произвольные данные записываются в nand_sector96+0x10 в резервной копии SysNAND, которая затем прошивается в устройство. После этого мы подаем команду на перезагрузку в MCU через i2c, записываем в какую-нибудь область памяти arm9 загрузчик (который будет писать содержимое 0x1000A040 - 0x1000A060 в файл на SD-карте), и заполняем всю память NOP-ами, за которым идут инструкции JMP указывающие на наш загрузчик. Затем мы можем циклично перезагружать MCU (и увеличивая значение nand_sector96+0х10 на 1 после каждого цикла) до тех пор, пока Kernel9Loader случайным образом не перейдет к загрузчику.

Из-за сложности и дополнительного аппаратного вмешательства в этом руководстве решено было рассматривать только метод, подразумевающий даунгрейд до прошивки ниже 3.0.0-X. Версия 2.1.0-X была выбрана, поскольку она является единственной версией ниже 3.0.0-X, которая содержит достаточно уязвимую версию браузера (2.0.0-X тоже имеет подходящую версию браузера, однако, эта версия не подходит по иным причинам).

Процесс включает в себя перепрошивку CTRNAND до версии 2.1.0-4. Все это возможно благодаря установке заранее подготовленного образа CTRNAND, содержащего 2.1.0 и копированию файлов, уникальных для вашей консоли (таких как `moveable.sed` и `SecureInfo_A`) прямо в него, а затем реструктуризации базы данных CMACS. В New 3DS мы так же меняем слот шифрования CTRNAND и устанавливаем в NAND заголовок NCSD от Old 3DS, что позволяет нам загрузить прошивку Old 3DS 2.1.0.